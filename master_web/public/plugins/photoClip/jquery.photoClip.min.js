!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","public/plugins/photoClip/iscroll-zoom","public/plugins/photoClip/hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("public/plugins/photoClip/iscroll-zoom"),require("public/plugins/photoClip/hammer"),require("lrz")):o(t.jQuery,t.IScroll,t.Hammer,t.lrz)}(this,function(t,o,e,i){"use strict";t.fn.photoClip=function(r){if(window.FileReader){var s={size:[260,260],outputSize:[0,0],file:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return t.extend(s,r),this.each(function(){!function(r,s){var c=s.size,l=s.outputSize,p=s.file,h=s.view,u=s.ok,d="image/jpeg",f=s.loadStart,m=s.loadComplete,g=s.loadError,v=s.clipFinish;$(c)||(c=[260,260]);$(l)||(l=[0,0]);var b,x,w,y,z,k,M,T,S,C,F,L,j,q=c[0]||260,R=c[1]||260,A=Math.max(l[0],0),E=Math.max(l[1],0),I=t(p);if(!I.length)return;I.change(function(){if(this.files.length){var o=this.files[0];if(!/image\/\w+/.test(o.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var e=new FileReader;e.onload=function(e){i(o).then(function(o){var e,i=o.origin.exifdata.PixelXDimension,n=o.origin.exifdata.PixelYDimension;if(i>=3264||n>=2448)return g.call(this,"Image size is too large (width cannot exceed 3264, height cannot exceed 2448)");e=o.base64,b&&b.length&&(b.remove(),delete b[0]),(b=t("<img>").css({"user-select":"none","pointer-events":"none"})).load(O),b.attr("src",e)}).catch(function(t){g.call(this,t)})},e.onerror=function(t){alert("图片加载失败"),g.call(this,t)},e.readAsDataURL(o),f.call(e,o)}}),I.click(function(){this.value=""}),function(){"static"==(z=t(r).css({"user-select":"none",overflow:"hidden"})).css("position")&&z.css("position","relative");k=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:q,height:R,"margin-left":-q/2,"margin-top":-R/2}).appendTo(z),M=t("<div class='photo-clip-moveLayer'>").appendTo(k),T=t("<div class='photo-clip-rotateLayer'>").appendTo(M);var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(z);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:R,"margin-right":q/2,"margin-top":-R/2,"margin-bottom":-R/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":q/2,"margin-top":-R/2,"margin-bottom":-R/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":R/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":R/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:q,height:R,"margin-left":-q/2-1,"margin-top":-R/2-1}).appendTo(o);(S=t(h)).length&&S.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}(),F=new o(k[0],{zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"}),function(){if(navigator.userAgent.match(/mobile/i)){var t,o,i=new e(M[0]);i.add(new e.Rotate),i.on("rotatemove",function(e){D||((t=e.rotation)>180?t-=360:t<-180&&(t+=360),o=t>0?1:t<0?-1:0)}),i.on("rotateend",function(e){D||Math.abs(t)>30&&(1==o?Z(e.center):-1==o&&B(-90,e.center))})}else M.on("dblclick",function(t){Z({x:t.clientX,y:t.clientY})})}(),C=document.createElement("canvas");var P=t(u);P.length&&P.click(function(){!function(){if(!y)return void alert("亲，当前没有图片可以裁剪!");var t=G(M,k),o=F.scale,e=C.getContext("2d");e.clearRect(0,0,C.width,C.height),e.save(),A&&E?(C.width=A,C.height=E,e.scale(A/q*o,E/R*o)):(C.width=q/o,C.height=R/o);let i=H-t.x/o,n=W-t.y/o;e.translate(i,n),e.rotate(X*Math.PI/180),e.drawImage(b[0],0,0),e.restore();let a={width:C.width,height:C.height,x:Math.abs(i),y:Math.abs(n)};var r=C.toDataURL(d,1);S.css("background-image","url("+r+")"),v.call(b[0],a,r)}()});var D,H,W,X,Y=t(window);function O(){y=!0,T.append(this),J.call(this,b,function(){x=this.naturalWidth,w=this.naturalHeight}),J(M,function(){!function(){H=0,W=0,X=0,T.css({width:x,height:w}),V(T,H,W,X),N(x,w),F.zoom(F.options.zoomStart),U(x,w);var t=.5*(q-x*F.options.zoomStart),o=.5*(R-w*F.options.zoomStart);F.scrollTo(t,o)}()}),m.call(this,this.src)}function U(t,o){M.css({width:t,height:o}),k.append(M),F.refresh()}function Z(t){B(90,t)}function B(t,o){if(!D){var e,i,r,s,c;D=!0,o?(i=M,r=o.x,s=o.y,r=r||0,s=s||0,J(i,function(){c=i.offset()}),e={x:r+Y.scrollLeft()-c.left,y:s+Y.scrollTop()-c.top}):e=G(M,k,.5*q,.5*R);var l,p,h=function(t,o){var e=F.scale,i={};0==t?(i.x=o.x/e,i.y=o.y/e):90==t||-270==t?(i.x=o.y/e,i.y=w-o.x/e):180==t||-180==t?(i.x=x-o.x/e,i.y=w-o.y/e):270!=t&&-90!=t||(i.x=x-o.y/e,i.y=o.x/e);return i}(X,e),u=h.x,d=h.y,f=0,m=0,g=0,v=0,b=X+t;90==b||-270==b?(f=u+d,m=d-u,b>X?(g=w-u-d,v=u-d):b<X&&(g=w-d-(x-u),v=u+d-w),l=w,p=x):180==b||-180==b?(f=2*u,m=2*d,b>X?(g=x-u-(w-d),v=w-(u+d)):b<X&&(g=x-(u+d),v=w-d-(x-u)),l=x,p=w):270==b||-90==b?(f=u-d,m=u+d,b>X?(g=u+d-x,v=x-u-(w-d)):b<X&&(g=d-u,v=x-u-d),l=w,p=x):0!=b&&360!=b&&-360!=b||(f=0,m=0,b>X?(g=u-d,v=u+d-x):b<X&&(g=u+d-w,v=d-u),l=x,p=w),0==X?(H=0,W=0):90==X||-270==X?(H-=u+d,W-=d-u):180==X||-180==X?(H-=2*u,W-=2*d):270!=X&&-90!=X||(H-=u-d,W-=u+d),H=H.toFixed(2)-0,W=W.toFixed(2)-0,V(T,H,W,X,u,d),function(t,o,e,i,r,s){t.css(a+"transform"),t.css(a+"transition",a+"transform "+r+"ms"),t.one(n,function(){t.css(a+"transition",""),s.call(this)}),t.css(a+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+i+"deg)")}(T,H,W,b,200,function(){D=!1,X=b%360,W+=m+v,H=(H+=f+g).toFixed(2)-0,W=W.toFixed(2)-0,V(T,H,W,X),F.scrollTo(F.x-g*F.scale,F.y-v*F.scale),N(l,p),F.scale<F.options.zoomMin&&F.zoom(F.options.zoomMin),U(l,p)})}}function Q(){J(z,function(){L=z.width(),j=z.height()})}function G(t,o,e,i){var n,a;return e=e||0,i=i||0,J(t,function(){n=t.offset()}),J(o,function(){a=o.offset()}),{x:a.left-n.left+e,y:a.top-n.top+i}}function J(o,e){var i=t();t.each(o,function(o,e){for(var n,a=t(e),r=a.parents().addBack().filter(":hidden"),o=0;o<r.length&&a.is(":hidden");o++)"none"==(n=r.eq(o)).css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(this),i.hide()}function K(t,o,e,i){var n=t/e,a=o/i;return n>a?n:a}function N(t,o){F.options.zoomMin=K(q,R,t,o),F.options.zoomMax=Math.max(1,F.options.zoomMin),F.options.zoomStart=Math.min(F.options.zoomMax,K(L,j,t,o))}function V(t,o,e,i,n,r){n=n||0,r=r||0;var s={};s[a+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+i+"deg)",s[a+"transform-origin"]=n+"px "+r+"px",t.css(s)}function $(t){return"[object Array]"===Object.prototype.toString.call(t)}Q(),Y.resize(Q)}(this,s)}),this}alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！")};var n,a="";return function(){var t,o,e={Webkit:"webkit",Moz:"",O:"o"},i=document.documentElement;for(var r in e)if(void 0!==i.style[r+"TransitionProperty"]){a="-"+r.toLowerCase()+"-",t=e[r];break}o="TransitionEnd",n=t?t+o:o.toLowerCase()}(),t});